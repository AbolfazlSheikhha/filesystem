# Developer Guide — Deadbeef Filesystem

This document explains how to build, test, and verify all project requirements.

## Project Requirements Checklist

### Part 1: Directory Support (via LKM)
- [x] **1.1** DirEntry structures (`deadbeef_disk_dirent`)
- [x] **1.2** Path resolution from root (`deadbeef_lookup`)
- [x] **1.3-5** cwd/cd/open — handled by Linux VFS (`chdir`, `open` syscalls)
- [x] **1.6** ls — `deadbeef_iterate` + standard `ls` command
- [x] **1.7** cp — `read_iter`/`write_iter` + standard `cp` command
- [x] **1.8** mv — `cp` + `rm` (rename not implemented, use cp+rm)

### Part 2: mkfs
- [x] `mkfs_deadbeef` formats disk images with proper on-disk layout

### Part 3: LKM Features
- [x] **3.1** Bitmap-based freelist (`deadbeef_rebuild_bitmap`, `alloc_block`, `free_block`)
- [x] **3.2** Variable-length files (linked block chains, 4092 bytes/block)
- [x] **3.3** Directory support (`mkdir`, `rmdir`, `lookup`, `iterate`)
- [x] **3.4** Multi-user locking (bonus) — `rw_semaphore` for concurrent access
- [x] **3.5** Linux permissions (bonus) — `chmod`, `chown`, `truncate` persistence

### Bonus: O(log n) Block Addressing
- [x] Implemented as O(1) via in-memory block map (better than required)

---

## Build Instructions

```bash
# Build everything
make

# Or separately
make mkfs_deadbeef   # Build formatter only
make lkm             # Build kernel module only
make clean           # Clean all build artifacts
```

### Dependencies
```bash
# Ubuntu/Debian
sudo apt install build-essential linux-headers-$(uname -r)
```

---

## Testing All Features

### 1. Setup Test Environment

```bash
# Create and format disk image
dd if=/dev/zero of=/tmp/deadbeef_test.img bs=1M count=64
./mkfs_deadbeef /tmp/deadbeef_test.img

# Load kernel module
sudo insmod lkm/deadbeef_fs.ko

# Setup loop device and mount
sudo losetup /dev/loop100 /tmp/deadbeef_test.img
sudo mkdir -p /mnt/deadbeef_test
sudo mount -t deadbeef /dev/loop100 /mnt/deadbeef_test

# Verify mount
mount | grep deadbeef
df -h /mnt/deadbeef_test
```

### 2. Test File Operations (Part 1.7, Part 3.2)

```bash
# Create files
echo "Hello World" | sudo tee /mnt/deadbeef_test/hello.txt
cat /mnt/deadbeef_test/hello.txt

# Large file (multi-block)
sudo dd if=/dev/urandom of=/mnt/deadbeef_test/big.bin bs=4096 count=100
ls -la /mnt/deadbeef_test/big.bin
# Expected: 409600 bytes

# Random read (tests O(1) block addressing)
sudo dd if=/mnt/deadbeef_test/big.bin bs=100 skip=500 count=1 | xxd | head

# Append
echo "More data" | sudo tee -a /mnt/deadbeef_test/hello.txt
cat /mnt/deadbeef_test/hello.txt

# Truncate
sudo truncate -s 5 /mnt/deadbeef_test/hello.txt
cat /mnt/deadbeef_test/hello.txt
sudo truncate -s 0 /mnt/deadbeef_test/hello.txt
ls -la /mnt/deadbeef_test/hello.txt
```

### 3. Test Directory Operations (Part 1.1, 1.2, 1.6, Part 3.3)

```bash
# Create directories
sudo mkdir /mnt/deadbeef_test/dir1
sudo mkdir /mnt/deadbeef_test/dir1/subdir
sudo mkdir /mnt/deadbeef_test/dir2

# List directories
ls -la /mnt/deadbeef_test/
ls -la /mnt/deadbeef_test/dir1/

# Create files in subdirectories
echo "nested" | sudo tee /mnt/deadbeef_test/dir1/subdir/nested.txt
cat /mnt/deadbeef_test/dir1/subdir/nested.txt

# Remove directories
sudo rmdir /mnt/deadbeef_test/dir2
sudo rm /mnt/deadbeef_test/dir1/subdir/nested.txt
sudo rmdir /mnt/deadbeef_test/dir1/subdir
sudo rmdir /mnt/deadbeef_test/dir1
```

### 4. Test Copy (Part 1.7)

```bash
echo "original" | sudo tee /mnt/deadbeef_test/original.txt
sudo cp /mnt/deadbeef_test/original.txt /mnt/deadbeef_test/copy.txt
cat /mnt/deadbeef_test/copy.txt
# Should show: original

# Copy from host to filesystem
sudo cp /etc/hostname /mnt/deadbeef_test/
cat /mnt/deadbeef_test/hostname

# Copy from filesystem to host
sudo cp /mnt/deadbeef_test/copy.txt /tmp/from_deadbeef.txt
cat /tmp/from_deadbeef.txt
```

### 5. Test Move (Part 1.8)

```bash
# Move = copy + remove (rename not implemented)
echo "moveme" | sudo tee /mnt/deadbeef_test/moveme.txt
sudo cp /mnt/deadbeef_test/moveme.txt /mnt/deadbeef_test/moved.txt
sudo rm /mnt/deadbeef_test/moveme.txt
ls /mnt/deadbeef_test/
# Should show moved.txt, not moveme.txt
```

### 6. Test Permissions (Bonus Part 3.5)

```bash
# Create file with default permissions
echo "secret" | sudo tee /mnt/deadbeef_test/secret.txt
ls -la /mnt/deadbeef_test/secret.txt

# chmod
sudo chmod 600 /mnt/deadbeef_test/secret.txt
ls -la /mnt/deadbeef_test/secret.txt
# Should show: -rw-------

sudo chmod 755 /mnt/deadbeef_test/secret.txt
ls -la /mnt/deadbeef_test/secret.txt
# Should show: -rwxr-xr-x

# chown
sudo chown 1000:1000 /mnt/deadbeef_test/secret.txt
ls -la /mnt/deadbeef_test/secret.txt
# Should show: owner changed

# Permission enforcement
sudo chmod 600 /mnt/deadbeef_test/secret.txt
sudo chown root:root /mnt/deadbeef_test/secret.txt
cat /mnt/deadbeef_test/secret.txt  # As non-root user
# Should show: Permission denied
```

### 7. Test Multi-user Locking (Bonus Part 3.4)

```bash
# Concurrent reads (should not block each other)
sudo cat /mnt/deadbeef_test/big.bin > /dev/null &
sudo cat /mnt/deadbeef_test/big.bin > /dev/null &
wait
echo "Concurrent reads completed"

# Concurrent writes to different files
echo "data1" | sudo tee /mnt/deadbeef_test/file1.txt &
echo "data2" | sudo tee /mnt/deadbeef_test/file2.txt &
wait
cat /mnt/deadbeef_test/file1.txt /mnt/deadbeef_test/file2.txt
```

### 8. Test Persistence (Remount)

```bash
# Create test data
echo "persist_test" | sudo tee /mnt/deadbeef_test/persist.txt
sudo chmod 640 /mnt/deadbeef_test/persist.txt
sudo chown 1000:1000 /mnt/deadbeef_test/persist.txt

# Unmount and remount
sudo umount /mnt/deadbeef_test
sudo mount -t deadbeef /dev/loop100 /mnt/deadbeef_test

# Verify persistence
cat /mnt/deadbeef_test/persist.txt
# Should show: persist_test
ls -la /mnt/deadbeef_test/persist.txt
# Should show: -rw-r----- 1000:1000
```

### 9. Test Free Space (Part 3.1)

```bash
# Check free space
df -h /mnt/deadbeef_test

# Fill up space
sudo dd if=/dev/zero of=/mnt/deadbeef_test/fillup.bin bs=1M count=50

# Check free space again
df -h /mnt/deadbeef_test

# Remove file, space should be reclaimed
sudo rm /mnt/deadbeef_test/fillup.bin
df -h /mnt/deadbeef_test
```

### 10. Cleanup

```bash
# Unmount
sudo umount /mnt/deadbeef_test

# Remove loop device
sudo losetup -d /dev/loop100

# Unload kernel module
sudo rmmod deadbeef_fs

# Verify unloaded
lsmod | grep deadbeef
# Should show nothing
```

---

## Kernel Log Debugging

```bash
# Watch kernel messages
sudo dmesg -w

# Or filter for deadbeef
sudo dmesg | grep deadbeef
```

---

## On-Disk Format Reference

| Offset | Size | Description |
|--------|------|-------------|
| 0 | 44 B | SuperBlock |
| 44 | 3392 B | User table (32 entries) |
| 3436 | 1184 B | Group table (32 entries) |
| 4620 | 930000 B | File table (10000 entries) |
| 934620 | ... | Data blocks (4096 B each) |

- Magic: `0xDEADBEEF`
- Block structure: 4-byte `next_block` + 4092 bytes data
- Directory entries: 64-byte name + 4-byte file_index

---

## Common Issues

### "Invalid argument" on mount
- Check magic number: `xxd /tmp/deadbeef_test.img | head -1`
- Should show: `dead beef`

### "No such file or directory" 
- Kernel module not loaded: `sudo insmod lkm/deadbeef_fs.ko`

### Module won't load
- Check kernel version match: `uname -r`
- Rebuild: `make clean && make lkm`

### Permission denied on operations
- Check if running as root or with sudo
- Check file permissions: `ls -la`
